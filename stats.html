<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Statistiky</title>

<style>
body{
  margin:0;
  font-family:system-ui;
  background:#0f172a;
  color:white;
}

.topbar{
  height:56px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 16px;
  background:#020617;
  border-bottom:1px solid #1f2937;
}

.menuBtn{
  padding:8px 14px;
  border-radius:10px;
  border:none;
  font-weight:800;
  background:#334155;
  color:white;
  cursor:pointer;
}

.container{
  padding:16px;
  max-width:900px;
  margin:auto;
}

.card{
  background:#111827;
  padding:16px;
  border-radius:14px;
  margin-bottom:12px;
}

.row{
  display:flex;
  justify-content:space-between;
  padding:6px 0;
  border-bottom:1px solid #1f2937;
}

.absence{
  color:#f87171;
  font-weight:800;
}

select{
  width:100%;
  padding:12px;
  border-radius:10px;
  border:none;
  margin-bottom:12px;
}

.loading{
  text-align:center;
  opacity:.7;
}

</style>
</head>

<body>

<div class="topbar">
  <div><b>üìà Statistiky</b></div>
  <button class="menuBtn" onclick="location.href='index.html'">Menu</button>
</div>

<div class="container">

<select id="workerSelect"></select>

<div id="out" class="card loading">Naƒç√≠t√°m‚Ä¶</div>

</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getFirestore, collection, getDocs } 
from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

const app = initializeApp({
 apiKey:"AIzaSyAYJCwb7Gn73JJQ_iNqh1eweds8SJL6K2o",
 authDomain:"shifter-ee3e6.firebaseapp.com",
 projectId:"shifter-ee3e6"
});

const db = getFirestore(app);

const sel = document.getElementById("workerSelect");
const out = document.getElementById("out");

let workersMap = {};
let shifts = [];

/* LOAD WORKERS */

const wSnap = await getDocs(collection(db,"employees"));
wSnap.forEach(d=>{
  const e=d.data();
  workersMap[d.id] = e.name+" "+e.surname;
});

sel.innerHTML = Object.entries(workersMap)
  .map(([id,name])=>`<option value="${id}">${name}</option>`)
  .join("");

/* LOAD SHIFTS */

const sSnap = await getDocs(collection(db,"shifts"));
sSnap.forEach(d=>shifts.push(d.data()));

sel.onchange = compute;
compute();

function compute(){

 const wid = sel.value;

 let phaseCount = 0;
 let shiftCount = 0;
 let reserveShiftCount = 0;
 let absenceCount = 0;
 const posCount = {};

 shifts.forEach(s=>{

   let workedThisShift = false;

   (s.phases || []).forEach(ph=>{
     Object.entries(ph).forEach(([pos,id])=>{
       if(id === wid){
         phaseCount++;
         posCount[pos] = (posCount[pos]||0)+1;
         workedThisShift = true;
       }
     });
   });

   if(workedThisShift){
     shiftCount++;
   }
 });

 /* RESERVE = byl work/shitmaking ale nebyl v ≈æ√°dn√© f√°zi */
 
 // bereme z employees statusToday snapshot ‚Äî hrub√Ω model
 
 // spoƒç√≠t√°me smƒõny kde nebyl nasazen ‚Üí ale existuje smƒõna
 const totalShiftDocs = shifts.length;
 if(totalShiftDocs > shiftCount){
   reserveShiftCount = totalShiftDocs - shiftCount;
 }

 /* ABSENCE ‚Äî z employees statusToday */
 
 // jednoduch√©: pokud dnes nen√≠ work/shitmaking ‚Üí absence++
 
 const emp = Object.entries(workersMap)
   .find(([id])=>id===wid);

 // absence model jen placeholder ‚Äî roz≈°i≈ôiteln√©
 absenceCount = 0; // zat√≠m bez historie stav≈Ø

 const posRows = Object.entries(posCount)
   .sort((a,b)=>b[1]-a[1])
   .map(([p,c])=>`<div class="row"><div>${p}</div><div>${c}</div></div>`)
   .join("");

 out.innerHTML = `
   <div class="row"><b>Odpracovan√© smƒõny</b><b>${shiftCount + reserveShiftCount}</b></div>
   <div class="row"><div>Aktivn√≠ nasazen√≠</div><div>${shiftCount}</div></div>
   <div class="row"><div>N√°hradn√≠k</div><div>${reserveShiftCount}</div></div>
   <div class="row"><div>F√°ze celkem</div><div>${phaseCount}</div></div>
   <div class="row absence"><div>Absence</div><div>${absenceCount}</div></div>
   <br>
   <b>Pozice:</b>
   ${posRows || "≈Ω√°dn√° data"}
 `;
}

</script>
</body>
</html>
