<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Statistiky</title>

<style>
body{margin:0;font-family:system-ui;background:#0f172a;color:white;}

.topbar{
 height:56px;display:flex;align-items:center;justify-content:space-between;
 padding:0 16px;background:#020617;border-bottom:1px solid #1f2937;
}

.menuBtn{
 padding:8px 14px;border-radius:10px;border:none;font-weight:800;
 background:#334155;color:white;cursor:pointer;
}

.container{max-width:1000px;margin:auto;padding:16px;}
.card{background:#111827;border-radius:16px;padding:16px;margin-bottom:14px;}

input{
 width:100%;padding:12px;border-radius:10px;border:none;
 margin-bottom:14px;font-weight:700;
}

.worker{font-weight:900;font-size:18px;margin-bottom:10px;}

.row{display:flex;justify-content:space-between;margin:6px 0;font-weight:700;}

.badge{padding:4px 10px;border-radius:999px;font-size:12px;font-weight:900;}
.active{background:#16a34a;}
.reserve{background:#2563eb;}
.absence{background:#dc2626;}

.barWrap{background:#020617;border-radius:10px;overflow:hidden;height:14px;margin-top:6px;}
.bar{height:100%;background:linear-gradient(90deg,#22c55e,#4ade80);}

.rankRow{
 display:flex;justify-content:space-between;padding:6px 0;
 font-weight:800;border-bottom:1px solid #1f2937;font-size:14px;
}

.posItem{font-size:13px;opacity:.9;}
.loading{text-align:center;opacity:.7;font-weight:900;}
</style>
</head>

<body>

<div class="topbar">
 <div><b>üìä Statistiky</b></div>
 <button class="menuBtn" onclick="location.href='index.html'">Menu</button>
</div>

<div class="container">

<input id="filter" placeholder="üîé Filtr podle jm√©na‚Ä¶">

<div class="card"><h3>üö® Nejvƒõt≈°√≠ absence</h3><div id="rankAbs"></div></div>
<div class="card"><h3>üî• Nejm√©nƒõ vyt√≠≈æen√≠</h3><div id="rankActive"></div></div>


<div id="cards"><div class="loading">Poƒç√≠t√°m data‚Ä¶</div></div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getFirestore, collection, getDocs }
from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

const app = initializeApp({
 apiKey:"AIzaSyAYJCwb7Gn73JJQ_iNqh1eweds8SJL6K2o",
 authDomain:"shifter-ee3e6.firebaseapp.com",
 projectId:"shifter-ee3e6"
});
const db = getFirestore(app);

const cardsEl = document.getElementById("cards");
const filterEl = document.getElementById("filter");
const rankAbsEl = document.getElementById("rankAbs");
const rankActiveEl = document.getElementById("rankActive");

/* LOAD */

const empSnap = await getDocs(collection(db,"employees"));
const shiftSnap = await getDocs(collection(db,"shifts"));

const empStatus={}, empNames={}, stats={}, posCount={};

empSnap.forEach(d=>{
 const e=d.data();

 empStatus[d.id] = e.statusToday || "work";
 empNames[d.id] = e.name+" "+e.surname;

 stats[d.id] = {
  active:0,
  reserve:0,
  absence:0,
  pos:{}
 };
});

/* =======================
   HLAVN√ç V√ùPOƒåET
======================= */

shiftSnap.forEach(docSnap=>{

 const shift = docSnap.data();
 const phases = shift.phases || [];

 // ‚úÖ LOANED = cel√° smƒõna = 4 f√°ze
 Object.entries(empStatus).forEach(([id,st])=>{
   if(st === "loaned"){
     stats[id].active += phases.length || 4;
   }
 });

 phases.forEach(phase=>{

   const used = new Set(Object.values(phase));

   /* ===== AKTIVN√ç POZICE ===== */

   Object.entries(phase).forEach(([pos,id])=>{

     if(!stats[id]) return;

     const st = empStatus[id];

     // loaned u≈æ m√° zapoƒç√≠t√°no za smƒõnu
     if(st === "loaned") return;

     // borrowed se poƒç√≠t√° jen kdy≈æ JE na pozici ‚Üí co≈æ pr√°vƒõ je
     stats[id].active++;

     stats[id].pos[pos] = (stats[id].pos[pos]||0)+1;
     posCount[pos] = (posCount[pos]||0)+1;
   });

   /* ===== MIMO POZICE ===== */

   Object.keys(stats).forEach(id=>{

     if(used.has(id)) return;

     const st = empStatus[id];

     if(st === "loaned") return;     // u≈æ zapoƒçteno
     if(st === "borrowed") return;   // mimo = nepoƒç√≠tat nic

     if(st==="sick"||st==="vacation"||st==="paragraf"){
       stats[id].absence++;
     }
     else if(st==="work" || st==="shitmaking"){
       stats[id].reserve++;
     }

   });

 });

});

/* =======================
   RANKINGS
======================= */

function top3(arr){
 return arr.sort((a,b)=>b.val-a.val).slice(0,3);
}

rankAbsEl.innerHTML="";
rankActiveEl.innerHTML="";

/* ABSENCE */

top3(
 Object.entries(stats)
  .filter(([id,s])=>s.absence>0)
  .map(([id,s])=>({
    name:empNames[id],
    val:s.absence
  }))
).forEach(x=>{
 rankAbsEl.innerHTML +=
   `<div class="rankRow">${x.name}<span>${x.val}</span></div>`;
});

/* NEJM√âNƒö VYT√ç≈ΩEN√ç */

const leastActive = Object.entries(stats)
  .filter(([id])=>{
    const st = empStatus[id];
    return st==="work" || st==="shitmaking" || st==="borrowed" || st==="loaned";
  })
  .map(([id,s])=>({
    name: empNames[id],
    val: s.active
  }))
  .sort((a,b)=>a.val-b.val)
  .slice(0,3);

leastActive.forEach(x=>{
  rankActiveEl.innerHTML +=
    `<div class="rankRow">${x.name}<span>${x.val}</span></div>`;
});

/* =======================
   KARTY
======================= */

function render(){

 const f = filterEl.value.toLowerCase();
 cardsEl.innerHTML="";

 Object.entries(stats).forEach(([id,s])=>{

  const name = empNames[id];
  if(!name.toLowerCase().includes(f)) return;

  const total = s.active+s.reserve+s.absence;
  if(!total) return;

  const pct = Math.round((s.active/total)*100);

  const div=document.createElement("div");
  div.className="card";

  div.innerHTML=`
   <div class="worker">${name}</div>

   <div class="row">Aktivn√≠<span class="badge active">${s.active}</span></div>
   <div class="row">N√°hradn√≠k<span class="badge reserve">${s.reserve}</span></div>
   <div class="row">Absence<span class="badge absence">${s.absence}</span></div>

   <div class="barWrap">
     <div class="bar" style="width:${pct}%"></div>
   </div>

   <div style="margin-top:10px;font-weight:800;">
     Pozice ‚Äî souƒçet:
   </div>

   ${
     Object.entries(s.pos)
       .sort((a,b)=>b[1]-a[1])
       .map(([p,c])=>`<div class="posItem">${p} ‚Äî ${c}√ó</div>`)
       .join("")
   }
  `;

  cardsEl.appendChild(div);

 });

}

filterEl.oninput = render;
render();

</script>
</body>
</html>
