<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gener√°tor smƒõny</title>

<style>
body{margin:0;font-family:system-ui;background:#0f172a;color:white;}

.topbar{
 height:48px;display:flex;align-items:center;
 justify-content:space-between;
 padding:0 12px;background:#020617;
 border-bottom:1px solid #1f2937;
}

.backMini{
 padding:8px 12px;border-radius:10px;
 border:none;font-weight:800;
 background:#334155;color:white;
}

.container{padding:16px;max-width:1000px;margin:auto;}

.card{
 background:#111827;
 padding:16px;
 border-radius:14px;
 margin-bottom:14px;
}

select,input{width:100%;padding:12px;border-radius:10px;border:none;margin-top:8px;}
button{padding:12px;border-radius:10px;border:none;margin-top:10px;}

.genBtn{background:#f59e0b;font-weight:900;width:100%;}
.saveBtn{background:#22c55e;font-weight:900;width:100%;}

/* TABLE */

.tableWrap{overflow:auto;border-radius:12px;border:1px solid #1f2937;}

table{width:100%;border-collapse:collapse;font-size:13px;}
th,td{padding:8px;border-bottom:1px solid #1f2937;text-align:center;}

th{background:#020617;position:sticky;top:0;}
.posCol{
 text-align:left;font-weight:800;
 background:#020617;
 position:sticky;left:0;
}

.small{opacity:.7;font-size:13px;}

/* LOADING */

.loading{
 position:fixed;
 inset:0;
 background:rgba(0,0,0,.7);
 display:none;
 align-items:center;
 justify-content:center;
 font-size:22px;
 font-weight:900;
 z-index:999;
}
</style>
</head>

<body>

<div class="loading" id="loading">üîç Generuji obsazen√≠‚Ä¶</div>

<div class="topbar">
<button class="backMini" onclick="location.href='index.html'">‚Üê Menu</button>
<div>Gener√°tor smƒõny</div>
</div>

<div class="container">

<div class="card">
<label>Datum</label>
<input type="date" id="date">

<label>Smƒõna</label>
<select id="shift">
<option value="ranni">Rann√≠</option>
<option value="odpo">Odpoledn√≠</option>
<option value="noc">Noƒçn√≠</option>
</select>

<button class="genBtn" id="genBtn">‚öôÔ∏è Obsadit pozice</button>
</div>

<div class="card">
<h4>Obsazen√≠ pozic</h4>
<div class="tableWrap">
<table id="grid"></table>
</div>
</div>

<div class="card">
<h4>N√°hradn√≠ci</h4>
<div id="reserves" class="small"></div>
</div>

<button class="saveBtn" id="saveBtn">üíæ Ulo≈æit smƒõnu</button>

</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getFirestore, collection, getDocs, doc, setDoc }
from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

const app = initializeApp({
 apiKey:"AIzaSyAYJCwb7Gn73JJQ_iNqh1eweds8SJL6K2o",
 authDomain:"shifter-ee3e6.firebaseapp.com",
 projectId:"shifter-ee3e6"
});

const db = getFirestore(app);

/* DOM */

const dateEl = document.getElementById("date");
const shiftEl = document.getElementById("shift");
const gridEl = document.getElementById("grid");
const reservesEl = document.getElementById("reserves");
const genBtn = document.getElementById("genBtn");
const saveBtn = document.getElementById("saveBtn");
const loading = document.getElementById("loading");

/* DEFAULT DATE */

dateEl.value = new Date().toISOString().slice(0,10);

/* POZICE (bez VET INST) */

const POSITIONS = [
"DP-L","DP-P","ZRC-L","ZRC-P","T-L","T-P",
"AGR-LP","AGR-PP","AGR-PZ","AGR-LZ",
"MOT-L","MOT-P","LEP-LP","LEP-PP","LEP-Z",
"REPRO-L","REPRO-P","VYP1-L","VYP1-P",
"VYP2-L","VYP2-P","PR-L","PR-P","ZAM-L","ZAM-P"
];

let phases=[];
let reserveWorkers=[];

/* TIME LABELS */

function phaseLabels(){
 const s = shiftEl.value;
 if(s==="ranni") return ["6‚Äì8","8‚Äì10","10‚Äì12","12‚Äì14"];
 if(s==="odpo") return ["14‚Äì16","16‚Äì18","18‚Äì20","20‚Äì22"];
 return ["22‚Äì00","00‚Äì02","02‚Äì04","04‚Äì06"];
}

/* BUILD PHASE1 */

async function buildPhase1(){

 const snap = await getDocs(collection(db,"employees"));

 const workers=[];
 snap.forEach(d=>{
  const e=d.data();
  if(e.statusToday==="work"){
    workers.push({
      id:d.id,
      name:e.name+" "+e.surname,
      skills:e.skills||[]
    });
  }
 });

 /* kandid√°ti pro ka≈ædou pozici */

 const candidatesMap = {};

 POSITIONS.forEach(pos=>{
   candidatesMap[pos] = workers.filter(w=>w.skills.includes(pos));
 });

 /* se≈ôadit pozice od nejtƒõ≈æ≈°√≠ch */

 const orderedPositions = [...POSITIONS]
   .sort((a,b)=>
     candidatesMap[a].length - candidatesMap[b].length
   );

 const used = new Set();
 const assign = {};

 for(const pos of orderedPositions){

   const cand = candidatesMap[pos]
     .filter(w=>!used.has(w.id))
     .sort(()=>Math.random()-.5)[0];

   if(cand){
     assign[pos] = cand;
     used.add(cand.id);
   } else {
     assign[pos] = null;
   }
 }

 reserveWorkers = workers.filter(w=>!used.has(w.id));

 return assign;
}

/* ROTACE */

function rotate(prev){

 const a={};
 const used=new Set();

 for(const pos of POSITIONS){

   const pw = prev[pos];
   if(!pw){a[pos]=null;continue;}

   if(pw.skills.length<=1){
     a[pos]=pw; used.add(pw.id); continue;
   }

   const cand = Object.values(prev)
     .filter(w=>w && w.id!==pw.id && w.skills.includes(pos) && !used.has(w.id))
     .sort(()=>Math.random()-.5)[0];

   if(cand){a[pos]=cand;used.add(cand.id);}
   else{a[pos]=pw;used.add(pw.id);}
 }

 return a;
}

/* GENERATE */

genBtn.onclick = async ()=>{

 loading.style.display="flex";
 genBtn.disabled = true;

 const p1 = await buildPhase1();
 const p2 = rotate(p1);
 const p3 = rotate(p2);
 const p4 = rotate(p3);

 phases=[p1,p2,p3,p4];
 render();

 loading.style.display="none";
 genBtn.disabled = false;
};

/* RENDER */

function render(){

 const labels = phaseLabels();

 let html = "<tr><th>Pozice</th>";
 labels.forEach(l=> html+=`<th>${l}</th>`);
 html+="</tr>";

 for(const pos of POSITIONS){
   html+=`<tr><td class="posCol">${pos}</td>`;
   phases.forEach(ph=>{
     html+=`<td>${ph[pos] ? ph[pos].name : "‚Äî"}</td>`;
   });
   html+="</tr>";
 }

 gridEl.innerHTML = html;

 reservesEl.innerHTML =
  reserveWorkers.length
   ? reserveWorkers.map(r=>r.name).join("<br>")
   : "Nikdo";
}

/* SAVE */

saveBtn.onclick = async ()=>{

 if(!phases.length){
   alert("Nejd≈ô√≠v generuj");
   return;
 }

 const out = phases.map(ph=>{
   const o={};
   Object.entries(ph).forEach(([k,w])=>{
     if(w) o[k]=w.id;
   });
   return o;
 });

 await setDoc(doc(db,"shifts",dateEl.value+"_"+shiftEl.value),{
  date:dateEl.value,
  shift:shiftEl.value,
  phases:out,
  reserves:reserveWorkers.map(r=>r.id),
  createdAt:Date.now()
 });

 alert("Ulo≈æeno");
};

</script>
</body>
</html>
