<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gener√°tor smƒõny</title>

<style>
body{margin:0;font-family:system-ui;background:#0f172a;color:white;}

.topbar{
 height:48px;display:flex;align-items:center;
 justify-content:space-between;
 padding:0 12px;background:#020617;
}

.container{padding:16px;max-width:1100px;margin:auto;}
.card{background:#111827;padding:16px;border-radius:14px;margin-bottom:14px;}

input,select{
 width:100%;padding:12px;border-radius:10px;border:none;margin-top:6px;
}

button{
 padding:12px;border-radius:10px;border:none;margin-top:10px;
 font-weight:800;
}

.genBtn{background:#f59e0b;width:100%;}
.saveBtn{background:#22c55e;width:100%;}

/* TABLE */

table{width:100%;border-collapse:collapse;font-size:13px;}
th,td{padding:8px;border-bottom:1px solid #1f2937;text-align:center;}
th{background:#020617;}
.posCol{font-weight:800;text-align:left;background:#020617;}
td.slot{cursor:pointer;}
td.slot:hover{background:#1f2937;}

/* RESERVES */

.resBox{
 background:#020617;
 padding:10px;
 border-radius:10px;
 margin-top:8px;
 font-size:13px;
 line-height:1.4;
}

/* MODAL */

.modal{
 position:fixed;inset:0;background:rgba(0,0,0,.7);
 display:none;align-items:center;justify-content:center;
}

.modalBox{
 background:#020617;padding:18px;border-radius:16px;
 width:90%;max-width:420px;
}

.pickBtn{
 width:100%;
 margin-top:8px;
 background:#2563eb;
 color:white;
}

.removeBtn{background:#ef4444;}

/* LOADING */

.loading{
 position:fixed;
 inset:0;
 background:rgba(0,0,0,.75);
 display:none;
 align-items:center;
 justify-content:center;
 font-size:22px;
 font-weight:900;
 z-index:999;
}
</style>
</head>

<body>

<div class="loading" id="loading">üîç Generuji smƒõnu‚Ä¶</div>

<div class="topbar">
<div>Gener√°tor smƒõny</div>
<button onclick="location.href='index.html'">Menu</button>
</div>

<div class="container">

<div class="card">

<label>Datum</label>
<input type="date" id="date">

<label>Smƒõna</label>
<select id="shift">
<option value="ranni">Rann√≠</option>
<option value="odpo">Odpoledn√≠</option>
<option value="noc">Noƒçn√≠</option>
</select>

<button class="genBtn" id="genBtn">‚öôÔ∏è Generovat</button>

</div>

<div class="card">
<table id="grid"></table>
</div>

<div class="card">
<h4>N√°hradn√≠ci podle f√°z√≠</h4>
<div id="reservesBox"></div>
</div>

<button class="saveBtn">üíæ Ulo≈æit</button>

</div>

<!-- PICK MODAL -->

<div class="modal" id="pickModal">
 <div class="modalBox">
   <div id="pickTitle"></div>
   <div id="pickList"></div>
   <button onclick="closePick()">Zav≈ô√≠t</button>
 </div>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getFirestore, collection, getDocs }
from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

/* FIREBASE */

const app = initializeApp({
 apiKey:"AIzaSyAYJCwb7Gn73JJQ_iNqh1eweds8SJL6K2o",
 authDomain:"shifter-ee3e6.firebaseapp.com",
 projectId:"shifter-ee3e6"
});

const db = getFirestore(app);

/* DOM */

const loadingEl = document.getElementById("loading");
const dateEl = document.getElementById("date");
const shiftEl = document.getElementById("shift");
const gridEl = document.getElementById("grid");
const reservesBoxEl = document.getElementById("reservesBox");
const genBtn = document.getElementById("genBtn");

dateEl.value = new Date().toISOString().slice(0,10);

/* POZICE */

const POSITIONS = [
"DP-L","DP-P","ZRC-L","ZRC-P","T-L","T-P",
"AGR-LP","AGR-PP","AGR-PZ","AGR-LZ",
"MOT-L","MOT-P","LEP-LP","LEP-PP","LEP-Z",
"REPRO-L","REPRO-P","VYP1-L","VYP1-P",
"VYP2-L","VYP2-P","PR-L","PR-P","ZAM-L","ZAM-P"
];

let workers=[];
let phases=[];
let phaseReserves=[];
let lastPosByWorker={};

/* LOAD WORKERS */

async function loadWorkers(){

 const snap = await getDocs(collection(db,"employees"));
 workers=[];

 snap.forEach(d=>{
  const e=d.data();
  if(e.statusToday==="work"){
    workers.push({
      id:d.id,
      name:e.name,
      skills:e.skills||[]
    });
  }
 });
}

/* SMART PHASE */

function buildPhase(){

 const map={};
 POSITIONS.forEach(p=>{
   map[p]=workers.filter(w=>w.skills.includes(p));
 });

 const ordered=[...POSITIONS]
   .sort((a,b)=>map[a].length-map[b].length);

 const used=new Set();
 const assign={};

 ordered.forEach(pos=>{

  const pool = map[pos]
   .filter(w=>!used.has(w.id))
   .map(w=>{
     const penalty = lastPosByWorker[w.id]===pos ? 0.25 : 1;
     return {w,score:Math.random()*penalty};
   })
   .sort((a,b)=>b.score-a.score);

  if(pool.length){
    assign[pos]=pool[0].w;
    used.add(pool[0].w.id);
    lastPosByWorker[pool[0].w.id]=pos;
  } else assign[pos]=null;

 });

 const reserves = workers.filter(w=>!used.has(w.id));
 return {assign,reserves};
}

/* GENERATE */

genBtn.onclick = async ()=>{

 loadingEl.style.display="flex";

 await loadWorkers();

 phases=[];
 phaseReserves=[];
 lastPosByWorker={};

 for(let i=0;i<4;i++){
   const {assign,reserves} = buildPhase();
   phases.push(assign);
   phaseReserves.push(reserves);
 }

 renderGrid();
 renderReserves();

 loadingEl.style.display="none";
};

/* TIME LABELS */

function phaseLabels(){
 const s=shiftEl.value;
 if(s==="ranni") return ["6-8","8-10","10-12","12-14"];
 if(s==="odpo") return ["14-16","16-18","18-20","20-22"];
 return ["22-00","00-02","02-04","04-06"];
}

/* RENDER GRID */

function renderGrid(){

 const L = phaseLabels();

 let html="<tr><th>Pozice</th>";
 L.forEach(x=>html+=`<th>${x}</th>`);
 html+="</tr>";

 POSITIONS.forEach(pos=>{
   html+=`<tr><td class="posCol">${pos}</td>`;
   for(let p=0;p<4;p++){
     const w=phases[p][pos];
     html+=`<td class="slot" onclick="pick(${p},'${pos}')">${w?w.name:"‚Äî"}</td>`;
   }
   html+="</tr>";
 });

 gridEl.innerHTML = html;
}

/* RENDER RESERVES */

function renderReserves(){

 reservesBoxEl.innerHTML = phaseReserves.map((arr,i)=>{

   const rows = arr.map(w=>
     `<div><b>${w.name}</b> ‚Äî ${w.skills.join(", ")}</div>`
   ).join("");

   return `<div class="resBox"><b>F√°ze ${i+1}</b><br>${rows||"Nikdo"}</div>`;

 }).join("");
}

/* PICK / SWAP */

let pickPhaseIndex;
let pickPosition;

window.pick = (phase,pos)=>{

 pickPhaseIndex=phase;
 pickPosition=pos;

 const list = phaseReserves[phase]
   .filter(w=>w.skills.includes(pos));

 pickTitle.innerText = pos;

 pickList.innerHTML =
   list.map(w=>
     `<button class="pickBtn" onclick="swapWorker('${w.id}')">${w.name}</button>`
   ).join("")
 + `<button class="pickBtn removeBtn" onclick="removeWorker()">Vypr√°zdnit</button>`;

 pickModal.style.display="flex";
};

window.swapWorker = (wid)=>{

 const w = workers.find(x=>x.id===wid);
 const cur = phases[pickPhaseIndex][pickPosition];

 if(cur) phaseReserves[pickPhaseIndex].push(cur);

 phases[pickPhaseIndex][pickPosition]=w;
 phaseReserves[pickPhaseIndex] =
   phaseReserves[pickPhaseIndex].filter(x=>x.id!==wid);

 closePick();
 renderGrid();
 renderReserves();
};

window.removeWorker = ()=>{

 const cur = phases[pickPhaseIndex][pickPosition];
 if(cur) phaseReserves[pickPhaseIndex].push(cur);

 phases[pickPhaseIndex][pickPosition]=null;

 closePick();
 renderGrid();
 renderReserves();
};

window.closePick = ()=> pickModal.style.display="none";

</script>
</body>
</html>
