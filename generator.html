<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gener√°tor smƒõny</title>

<style>
body{margin:0;font-family:system-ui;background:#0f172a;color:white;}

.topbar{
 height:56px;
 display:flex;
 align-items:center;
 justify-content:space-between;
 padding:0 16px;
 background:#020617;
 border-bottom:1px solid #1f2937;
}

.menuBtn{
 padding:8px 14px;
 border-radius:10px;
 border:none;
 font-weight:800;
 background:#334155;
 color:white;
 cursor:pointer;
}

.container{padding:16px;max-width:1200px;margin:auto;}
.card{background:#111827;padding:16px;border-radius:14px;margin-bottom:14px;}

input,select{
 width:100%;padding:12px;border-radius:10px;border:none;margin-top:6px;
}

button{
 padding:12px;border-radius:10px;border:none;margin-top:10px;
 font-weight:800;
}

.genBtn{background:#f59e0b;width:100%;}
.saveBtn{background:#22c55e;width:100%;}

/* LOCK PANEL */

details{
 background:#020617;
 border-radius:10px;
 padding:10px;
 margin-top:10px;
}

details summary{
 cursor:pointer;
 font-weight:800;
 margin-bottom:8px;
}
.loadBtn{
  background:#2563eb;
  width:100%;
  color:white;
}

.loadBtn:hover{
  filter:brightness(1.15);
}

.loadBtn:active{
  transform:scale(.97);
}

.lockList{
 max-height:160px;
 overflow:auto;
 font-size:13px;
}

.lockList{
 max-height:180px;
 overflow:auto;
 font-size:14px;
 margin-top:8px;
}

.lockRow{
 display:flex;
 align-items:center;
 gap:10px;
 padding:6px 8px;
 border-radius:8px;
 cursor:pointer;
}

.lockRow:hover{
 background:#1f2937;
}

.lockRow input{
 width:18px;
 height:18px;
 cursor:pointer;
}

.lockCode{
 font-weight:800;
 width:72px;
}

.lockName{
 opacity:.8;
 font-size:13px;
}

.lockedRow{
 background:rgba(220,38,38,0.18); /* ƒçerven√° pr≈Øhledn√° */
}

.lockedRow td{
 background:rgba(220,38,38,0.18);
}

.lockedRow:hover td{
 background:rgba(220,38,38,0.28);
}

/* TABLE */

table{width:100%;border-collapse:collapse;font-size:13px;}
th,td{padding:8px;border-bottom:1px solid #1f2937;text-align:center;}
th{background:#020617;}
.posCol{font-weight:800;text-align:left;background:#020617;}
td.slot{cursor:pointer;}
td.slot:hover{background:#1f2937;}

/* RESERVES */

.resBox{
 background:#020617;
 padding:10px;
 border-radius:10px;
 margin-top:8px;
 font-size:13px;
 line-height:1.4;
}

/* MODAL */

.modal{
 position:fixed;inset:0;background:rgba(0,0,0,.7);
 display:none;align-items:center;justify-content:center;
}

.modalBox{
 background:#020617;padding:18px;border-radius:16px;
 width:90%;max-width:420px;
}

.pickBtn{
 width:100%;
 margin-top:8px;
 background:#2563eb;
 color:white;
}

.removeBtn{background:#ef4444;}

/* LOADING */

.loading{
 position:fixed;inset:0;background:rgba(0,0,0,.75);
 display:none;align-items:center;justify-content:center;
 font-size:22px;font-weight:900;z-index:999;
}
</style>
</head>

<body>

<div class="loading" id="loading">üîç Pracuju‚Ä¶</div>

<div class="topbar">
<div><b>‚öôÔ∏è Gener√°tor smƒõny</b></div>
<button class="menuBtn" onclick="location.href='index.html'">Menu</button>
</div>

<div class="container">

<div class="card">
<label>Datum</label>
<input type="date" id="date">

<label>Smƒõna</label>
<select id="shift">
<option value="ranni">Rann√≠</option>
<option value="odpo">Odpoledn√≠</option>
<option value="noc">Noƒçn√≠</option>
</select>

<details>
<summary>üîí Vy≈ôadit pozice z generov√°n√≠</summary>
<div class="lockList" id="lockBox"></div>
</details>

<button class="genBtn" id="genBtn">‚öôÔ∏è Generovat</button>
<button class="loadBtn" id="loadBtn">üìÇ Naƒç√≠st ulo≈æenou smƒõnu</button>
</div>

<div class="card">
<table id="grid"></table>
</div>

<div class="card">
<h4>N√°hradn√≠ci podle f√°z√≠</h4>
<div id="reservesBox"></div>
</div>

<button class="saveBtn" id="saveBtn">üíæ Ulo≈æit</button>

</div>

<div class="modal" id="pickModal">
<div class="modalBox">
<div id="pickTitle"></div>
<div id="pickList"></div>
<button onclick="closePick()">Zav≈ô√≠t</button>
</div>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getFirestore, collection, getDocs, doc, setDoc, getDoc }
from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

const app = initializeApp({
 apiKey:"AIzaSyAYJCwb7Gn73JJQ_iNqh1eweds8SJL6K2o",
 authDomain:"shifter-ee3e6.firebaseapp.com",
 projectId:"shifter-ee3e6"
});

const db = getFirestore(app);

/* DOM */

const loadingEl = document.getElementById("loading");
const dateEl = document.getElementById("date");
const shiftEl = document.getElementById("shift");
const gridEl = document.getElementById("grid");
const reservesBoxEl = document.getElementById("reservesBox");

const genBtn = document.getElementById("genBtn");
const loadBtn = document.getElementById("loadBtn");
const saveBtn = document.getElementById("saveBtn");
const lockBox = document.getElementById("lockBox");

const pickModal = document.getElementById("pickModal");
const pickTitle = document.getElementById("pickTitle");
const pickList = document.getElementById("pickList");

dateEl.value = new Date().toISOString().slice(0,10);

/* POSITIONS */

const POSITIONS = [
"DP-L","DP-P","ZRC-L","ZRC-P","T-L","T-P",
"AGR-LP","AGR-PP","AGR-PZ","AGR-LZ",
"MOT-L","MOT-P","LEP-LP","LEP-PP","LEP-Z",
"REPRO-L","REPRO-P","VYP1-L","VYP1-P",
"VYP2-L","VYP2-P","PR-L","PR-P","ZAM-L","ZAM-P","VET","INST",
];

POSITIONS.forEach(p=>{
 lockBox.innerHTML += `
 <label class="lockRow">
  <input type="checkbox" value="${p}">
  <span>${p}</span>
 </label>`;
});

function lockedPositions(){
 return [...lockBox.querySelectorAll("input:checked")].map(x=>x.value);
}

function activePositions(){
 const locked = lockedPositions();
 return POSITIONS.filter(p=>!locked.includes(p));
}

/* STATE */

let workers=[];
let phases=[];
let phaseReserves=[];
let lastPosByWorker={};

/* WORKERS */

async function loadWorkers(){
 const snap = await getDocs(collection(db,"employees"));
 workers=[];
 snap.forEach(d=>{
  const e=d.data();
  if(e.statusToday==="work"){
    workers.push({id:d.id,name:e.name,skills:e.skills||[]});
  }
 });
}

/* BUILD */

function buildPhase(act){

 const used=new Set();
 const assign={};

 const ordered=[...act].sort((a,b)=>
  workers.filter(w=>w.skills.includes(a)).length -
  workers.filter(w=>w.skills.includes(b)).length
 );

 ordered.forEach(pos=>{
  const pool = workers
   .filter(w=>w.skills.includes(pos)&&!used.has(w.id))
   .sort(()=>Math.random()-.5);

  if(pool.length){
   assign[pos]=pool[0];
   used.add(pool[0].id);
  } else assign[pos]=null;
 });

 const reserves = workers.filter(w=>!used.has(w.id));
 return {assign,reserves};
}

/* GENERATE */

genBtn.onclick = async ()=>{
 loadingEl.style.display="flex";
 await loadWorkers();

 phases=[]; phaseReserves=[];
 const act=activePositions();

 for(let i=0;i<4;i++){
  const {assign,reserves}=buildPhase(act);
  phases.push(assign);
  phaseReserves.push(reserves);
 }

 render();
 loadingEl.style.display="none";
};

/* LOAD */

loadBtn.onclick = async ()=>{

 loadingEl.style.display="flex";
 await loadWorkers();

 const id=dateEl.value+"_"+shiftEl.value;
 const snap=await getDoc(doc(db,"shifts",id));

 if(!snap.exists()){
  alert("Smƒõna neexistuje");
  loadingEl.style.display="none";
  return;
 }

 const data=snap.data();
 const map={}; workers.forEach(w=>map[w.id]=w);

 phases = data.phases.map(ph=>{
  const o={};
  Object.entries(ph).forEach(([pos,id])=>{
   o[pos]=map[id]||null;
  });
  return o;
 });

 phaseReserves = phases.map(ph=>{
  const used=new Set(Object.values(ph).filter(Boolean).map(w=>w.id));
  return workers.filter(w=>!used.has(w.id));
 });

 render();
 loadingEl.style.display="none";
};

/* RENDER */

function phaseLabels(){
 const s=shiftEl.value;
 if(s==="ranni") return ["6:00-8:00","8:00-10:15","10:45-12:00","12:00-14:00"];
 if(s==="odpo") return ["14:00-16:00","16:00-18:15","18:45-20:00","20:00-22:00"];
 return ["22:00-00:00","00:00-02:15","02:45-04:00","04:00-06:00"];
}

function render(){

 const L=phaseLabels();
 const locked = new Set(lockedPositions());

 let html="<tr><th>Pozice</th>";
 L.forEach(x=>html+=`<th>${x}</th>`);
 html+="</tr>";

 POSITIONS.forEach(pos=>{
  const isLocked = locked.has(pos);
  html+=`<tr class="${isLocked?'lockedRow':''}">
  <td class="posCol">
   ${pos} ${isLocked?'üîí':''}
   <button onclick="toggleLock('${pos}')">üîì</button>
  </td>`;

  for(let p=0;p<4;p++){
   const w=phases[p]?.[pos];
   html+=`<td class="slot" onclick="pick(${p},'${pos}')">${w?w.name:"‚Äî"}</td>`;
  }

  html+="</tr>";
 });

 gridEl.innerHTML=html;

 reservesBoxEl.innerHTML =
 phaseReserves.map((arr,i)=>
 `<div class="resBox"><b>F√°ze ${i+1}</b><br>${
 arr.map(w=>w.name+" ‚Äî "+w.skills.join(", ")).join("<br>")||"Nikdo"
 }</div>`).join("");
}

/* LOCK TOGGLE */

window.toggleLock=(pos)=>{
 const cb=[...lockBox.querySelectorAll("input")].find(x=>x.value===pos);
 if(cb) cb.checked=!cb.checked;
 render();
};

/* PICK */

let pickPhaseIndex,pickPosition;

window.pick=(phase,pos)=>{
 pickPhaseIndex=phase;
 pickPosition=pos;
 const list=phaseReserves[phase].filter(w=>w.skills.includes(pos));
 pickTitle.innerText="Pozice "+pos;
 pickList.innerHTML=
 list.map(w=>`<button class="pickBtn" onclick="swapWorker('${w.id}')">${w.name}</button>`).join("")
 + `<button class="pickBtn removeBtn" onclick="removeWorker()">Vypr√°zdnit</button>`;
 pickModal.style.display="flex";
};

window.swapWorker=(wid)=>{
 const w=workers.find(x=>x.id===wid);
 const cur=phases[pickPhaseIndex][pickPosition];
 if(cur) phaseReserves[pickPhaseIndex].push(cur);
 phases[pickPhaseIndex][pickPosition]=w;
 phaseReserves[pickPhaseIndex]=phaseReserves[pickPhaseIndex].filter(x=>x.id!==wid);
 closePick(); render();
};

window.removeWorker=()=>{
 const cur=phases[pickPhaseIndex][pickPosition];
 if(cur) phaseReserves[pickPhaseIndex].push(cur);
 phases[pickPhaseIndex][pickPosition]=null;
 closePick(); render();
};

window.closePick=()=> pickModal.style.display="none";

/* SAVE */

saveBtn.onclick = async ()=>{

 if(!phases.length){
  alert("Nejd≈ô√≠v generuj");
  return;
 }

 const out = phases.map(ph=>{
  const o={};
  Object.entries(ph).forEach(([pos,w])=>{
   if(w) o[pos]=w.id;
  });
  return o;
 });

 await setDoc(doc(db,"shifts",dateEl.value+"_"+shiftEl.value),{
  date:dateEl.value,
  shift:shiftEl.value,
  phases:out,
  createdAt:Date.now()
 });

 alert("‚úÖ Ulo≈æeno");
};

</script>
</body>
</html>
